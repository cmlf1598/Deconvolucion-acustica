
%% Parámetros generales
clear; clc;

%Señal de prueba
signal_type = "musical_clip";
track_no = 1;

%Duración 
switch signal_type 
    

fs = 44100; %frecuencia de muestreo
tf = 15;

%% Hiperparámetros

%Capas
i_n = 20;
L1_n = 10;
o_n = 1;

%
initial_learning_rate = 0.01;
beta_1 = 0.9;
%% Cargar data y otros ajustes

switch signal_type
    case "musical_clip"
        data_folder = fullfile('D:\','UVG','Proyecto de investigacion','Deconvolucion-acustica', 'Audio data',...
                               'Clips grabados y originales','clips musicales',{'originales';'grabados'});
    case "determista"
        data_folder = fullfile('D:\','UVG','Proyecto de investigacion','Deconvolucion-acustica', 'Audio data',...
                               'Clips grabados y originales','data determinista',{'originales';'grabados'});
end 
ads = audioDatastore(data_folder);
%%

%audioread(char(ads.Files(1)));
ads_d_n = audioDatastore(data_folder{1}); 
ads_x_n = audioDatastore(data_folder{2}); 

%%
%Señales 
d_n = read(ads_d_n); %deseada
x_n = read(ads_x_n); %perturbada

%%
[d_n, x_n] = pair_tracks(d_n, x_n); %emparejamiento temporal
x_n = x_n(1:tf*fs);
d_n = d_n(1:tf*fs);
[X] = tapped_delay_mat(x_n, i_n); %matriz TDNN
Y = d_n';

%% Data de entrenamiento y validación
[duration, ~] = size(x_n);
train_frac = 0.8;
%t_train = tf*train_frac;
%t_validation = tf*(1 - train_frac);

%data de entrenamiento
X_train = X(:, 1:round(duration*train_frac)); 
Y_train = Y(:, 1:round(duration*train_frac)); 
[~, limit_index] = size(Y_train);

%% data de validación
X_validation =  X(:, limit_index:end); 
Y_validation = Y(:, limit_index:end); 

%%

layers = [...
    sequenceInputLayer(i_n)
    fullyConnectedLayer(L1_n)
    tanhLayer
    fullyConnectedLayer(size(Y,1))
    regressionLayer];

%%

options = trainingOptions('adam', ...
    'MaxEpochs', 50,...
    'ValidationData',{X_validation,Y_validation}, ...
    'ValidationFrequency', 60, ...
    'InitialLearnRate', initial_learning_rate);
%%

net = trainNetwork(X_train,Y_train,layers,options);